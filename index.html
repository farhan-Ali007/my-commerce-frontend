<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Optimized Google Tag Manager (load after interaction) -->
    <script>
      (function (w, d, s, l, i) {
        // Minimal dataLayer stub
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        
        function loadGTM() {
          if (w.__gtmLoaded) return;
          w.__gtmLoaded = true;
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != "dataLayer" ? "&l=" + l : "";
          j.async = true;
          j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
          f.parentNode.insertBefore(j, f);
        }
        
        // Load GTM after user interaction or on commerce pages
        var path = (w.location && w.location.pathname) || '/';
        var isCommercePage = /\b(product|cart|checkout)\b/.test(path);
        
        if (isCommercePage) {
          // Load immediately on commerce pages
          (w.requestIdleCallback || function(cb){ setTimeout(cb, 100); })(loadGTM);
        } else {
          // Load after first interaction on other pages
          var events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
          var loaded = false;
          var loadOnce = function() {
            if (loaded) return;
            loaded = true;
            events.forEach(function(e) {
              d.removeEventListener(e, loadOnce, { passive: true });
            });
            (w.requestIdleCallback || function(cb){ setTimeout(cb, 100); })(loadGTM);
          };
          events.forEach(function(e) {
            d.addEventListener(e, loadOnce, { passive: true, once: true });
          });
          // Fallback: load after 3 seconds
          setTimeout(loadOnce, 3000);
        }
      })(window, document, "script", "dataLayer", "GTM-WB2JJH4Z");
    </script>
    <!-- End Optimized Google Tag Manager -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <!-- Mobile performance hints -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <!-- Performance: Preconnect to critical origins with mobile priority -->
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
    <link rel="preconnect" href="https://etimadmart.up.railway.app" crossorigin>
    <link rel="dns-prefetch" href="//res.cloudinary.com">
    <link rel="dns-prefetch" href="//etimadmart.up.railway.app">
    
    <!-- Only preconnect fonts on desktop to avoid mobile blocking -->
    <link rel="preconnect" href="https://fonts.googleapis.com" media="(min-width: 769px)">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin media="(min-width: 769px)">

    <!-- Critical LCP Image Preload - Mobile First -->
    <link
      rel="preload"
      as="image"
      href="/customBanner1.webp"
      media="(max-width: 640px)"
      fetchpriority="high"
    />
    <link
      rel="preload"
      as="image"
      href="/customBanner1.webp"
      media="(min-width: 641px)"
      fetchpriority="high"
    />
    
    <!-- Preload second banner for faster carousel -->
    <link
      rel="preload"
      as="image"
      href="/customBanner2.webp"
      fetchpriority="low"
    />
    
    <!-- Critical Resource Hints -->
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
    <link rel="preconnect" href="https://etimadmart.up.railway.app" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- DNS Prefetch for non-critical resources -->
    <link rel="dns-prefetch" href="//connect.facebook.net">
    <link rel="dns-prefetch" href="//www.facebook.com">
    <link rel="dns-prefetch" href="//www.googletagmanager.com">
    <!-- Preload splash logo early so it appears instantly -->
    <link rel="preload" as="image" href="/f-logo.png" />
    
    <!-- Critical CSS for LCP optimization -->
    <style>
      /* Critical above-the-fold styles to prevent layout shift */
      .banner-container {
        width: 100%;
        max-width: 100vw;
        aspect-ratio: 1920/550;
        background-color: #f3f4f6;
        position: relative;
        overflow: hidden;
      }
      
      .banner-image {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
      }
      
      /* Prevent layout shift for navigation dots */
      .banner-dots {
        display: flex;
        justify-content: center;
        margin: 8px 0;
        min-height: 32px;
      }
    </style>
    <!-- Content Security Policy Meta Tag (Backup for cPanel) -->
    <meta
      http-equiv="Content-Security-Policy"
      content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://connect.facebook.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' data: https://fonts.gstatic.com;
    img-src 'self' data: https: blob: https://res.cloudinary.com https://www.facebook.com;
    connect-src 'self' https://etimadmart.com   https://etimadmart.up.railway.app https://etimadmart.com/api/v1 https://www.google-analytics.com https://res.cloudinary.com https://www.facebook.com;
    frame-src 'self';
    object-src 'none';
    base-uri 'self';
    form-action 'self'
  "
    />
    <meta
      name="google-site-verification"
      content="XFfrylpN_jyzGe1E23oSqq85BIkGc_GUToUX4Sv1jyg"
    />
    <link rel="icon" type="image/png" href="/top-logo.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Load Poppins asynchronously to avoid render-blocking; rely on system-ui fallback initially -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    </noscript>

    <!-- Secondary fonts loaded asynchronously to avoid render-blocking -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Space+Grotesk:wght@400;500;700&display=swap"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet" />
    </noscript>
    
    <!-- CRITICAL CSS FOR PERFORMANCE - EXPANDED -->
    <style>
      /* Critical CSS for Above-the-Fold Content - Inlined for best performance */
      
      /* Base styles */
      *,*::before,*::after{box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell',sans-serif;line-height:1.6;color:#333;margin:0;padding:0;background-color:#fff}
      
      /* Layout containers */
      .main-container{min-height:100vh;display:flex;flex-direction:column}.content-wrapper{flex:1}
      
      /* Navbar critical styles */
      .navbar{position:sticky;top:0;z-index:1000;background-color:white;box-shadow:0 2px 4px rgba(0,0,0,0.1);padding:0.75rem 1rem;display:flex;align-items:center;justify-content:between}
      
      /* Banner critical styles */
      .banner-container{position:relative;width:100%;height:0;padding-top:28.65%;background-color:#f3f4f6;overflow:hidden;contain:layout style paint}.banner-image{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center}.banner-skeleton{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
      
      /* Product grid critical styles */
      .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;padding:1rem}.product-card{background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform 0.2s,box-shadow 0.2s}.product-card:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.15)}
      
      /* Button critical styles */
      .btn{display:inline-flex;align-items:center;justify-content:center;padding:0.5rem 1rem;border-radius:6px;font-weight:500;text-decoration:none;border:none;cursor:pointer;transition:all 0.2s}.btn-primary{background-color:#f59e0b;color:white}.btn-primary:hover{background-color:#d97706}
      
      /* Loading animations */
      @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
      
      /* Skeleton loaders */
      .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
      
      /* Mobile-first responsive breakpoints with exact aspect ratios */
      @media (max-width:640px){
        /* Critical banner layout for mobile LCP */
        .banner-container{
          padding-top:29.17%;
          min-height:140px;
          background-color:transparent;
          position:relative;
          width:100%;
          overflow:hidden;
        }
        .banner-container img{
          position:absolute;
          top:0;
          left:0;
          width:100%;
          height:100%;
          object-fit:cover;
          object-position:center;
        }
        .product-grid{grid-template-columns:repeat(2,1fr);gap:0.5rem;padding:0.5rem}
        /* Mobile navigation optimization */
        .navbar{padding:0.25rem;font-size:0.875rem;min-height:auto}
        /* Mobile-specific optimizations */
        body{font-size:14px;line-height:1.4;font-display:swap}
        .container{padding:0.25rem}
        /* Reduce mobile margins for faster paint */
        .my-8{margin-top:0.5rem!important;margin-bottom:0.5rem!important}
        .py-8{padding-top:0.5rem!important;padding-bottom:0.5rem!important}
        /* Hide non-critical elements on mobile initially */
        .mobile-hidden{display:none!important}
      }
      @media (max-width:1024px) and (min-width:641px){
        .banner-container{padding-top:31.25%;min-height:320px}
      }
      /* Desktop optimization */
      @media (min-width:1025px){
        .banner-container{padding-top:28.65%;min-height:550px}
      }
      
      /* Performance optimizations */
      .prevent-cls{contain:layout style paint}.focus-visible{outline:2px solid #4F46E5;outline-offset:2px}
      
      /* Reduced motion */
      @media (prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important}}
      
      /* Hide non-critical content initially */
      .below-fold{visibility:hidden}.below-fold.loaded{visibility:visible}
    </style>
    
    <!-- CSS Loading Strategy -->
    <script>
      // Defer non-critical CSS loading
      (function() {
        function loadCSS(href, media) {
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = href;
          link.media = media || 'all';
          document.head.appendChild(link);
        }
        
        // Load main CSS after critical rendering
        if (window.requestIdleCallback) {
          requestIdleCallback(function() {
            // Main CSS will be injected by Vite, but we ensure it's non-blocking
            document.documentElement.classList.add('css-loaded');
          });
        } else {
          setTimeout(function() {
            document.documentElement.classList.add('css-loaded');
          }, 100);
        }
        
        // Show below-fold content after initial render
        document.addEventListener('DOMContentLoaded', function() {
          setTimeout(function() {
            var belowFoldElements = document.querySelectorAll('.below-fold');
            belowFoldElements.forEach(function(el) {
              el.classList.add('loaded');
            });
          }, 50);
        });
      })();
    </script>
    
    <!-- CRITICAL RESOURCE PRELOADS -->
    <link rel="preload" href="/customBanner2.webp" as="image" fetchpriority="high">
    <link rel="preload" href="https://res.cloudinary.com/dqcfamwuf/image/upload/v1751867708/banners/yuky_v1.webp" as="image" fetchpriority="high">
    
    <!-- ADDITIONAL PERFORMANCE OPTIMIZATIONS -->
    <link rel="dns-prefetch" href="//etimadmart.up.railway.app">
    <link rel="dns-prefetch" href="//res.cloudinary.com">
    <meta name="theme-color" content="#ffffff">
    <meta name="color-scheme" content="light">
    
    <title>Etimad Mart</title>
    <!-- Minimal Google Analytics (defer until interaction) -->
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      
      function loadGA() {
        if (window.__gaLoaded) return;
        window.__gaLoaded = true;
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=G-E9DQ6Y0HFP';
        document.head.appendChild(s);
        s.onload = function() {
          gtag('js', new Date());
          gtag('config', 'G-E9DQ6Y0HFP', {
            send_page_view: false // Prevent automatic pageview
          });
          gtag('event', 'page_view'); // Manual pageview
        };
      }
      
      // Load GA after user interaction
      var events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
      var loaded = false;
      var loadOnce = function() {
        if (loaded) return;
        loaded = true;
        events.forEach(function(e) {
          document.removeEventListener(e, loadOnce);
        });
        (window.requestIdleCallback || function(cb){ setTimeout(cb, 200); })(loadGA);
      };
      events.forEach(function(e) {
        document.addEventListener(e, loadOnce, { passive: true, once: true });
      });
      // Fallback: load after 4 seconds
      setTimeout(loadOnce, 4000);
    </script>
    <!-- Meta Pixel (Facebook Pixel) - Fixed for all pages -->
    <script>
      (function (w, d) {
        // Initialize Facebook Pixel on all pages
        if (!w.fbq) {
          var n = function(){ n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments); };
          n.queue = []; n.version = '2.0'; n.loaded = false; w.fbq = n; w._fbq = n;
        }
        
        // Load the pixel script
        function loadFbPixel() {
          if (w.__fbPixelLoaded) return;
          w.__fbPixelLoaded = true;
          
          var s = d.createElement('script');
          s.async = true;
          s.src = 'https://connect.facebook.net/en_US/fbevents.js';
          s.crossOrigin = 'anonymous';
          s.referrerPolicy = 'strict-origin-when-cross-origin';
          var first = d.getElementsByTagName('script')[0];
          first.parentNode.insertBefore(s, first);
          s.onload = function(){
            try { 
              // Production-specific configuration
              fbq('init', '2204362540002843', {
                // Enable automatic advanced matching for better tracking
                em: 'auto',
                // Enable external ID for better user matching
                external_id: 'auto',
                // Set your domain for proper attribution
                domain_name: window.location.hostname
              }); 
              
              // Track PageView with enhanced data
              fbq('track', 'PageView', {
                source: 'website',
                domain: window.location.hostname,
                page_title: document.title,
                page_url: window.location.href
              }); 
            } catch(e) {
              console.warn('Meta Pixel error:', e);
            }
          };
        }

        // Load immediately for better event tracking
        loadFbPixel();
        
        // Debug: Test pixel after load
        setTimeout(function() {
          var isProduction = w.location.hostname !== 'localhost' && 
                           !w.location.hostname.includes('127.0.0.1') &&
                           !w.location.hostname.includes('localhost');
          
          if (w.fbq && typeof w.fbq === 'function') {
            console.log('✅ Meta Pixel loaded successfully on', w.location.hostname);
            
            // Only send test event in development
            if (!isProduction) {
              w.fbq('track', 'CustomEvent', { test: 'pixel_loaded', environment: 'development' });
            } else {
              console.log('🚀 Production Meta Pixel ready for real events');
            }
          } else {
            console.warn('❌ Meta Pixel failed to load');
          }
        }, 2000);
      })(window, document);
    </script>
    <!-- End Meta Pixel -->
    
    <!-- PERFORMANCE MONITORING & OPTIMIZATION SCRIPT -->
    <script>
      // Performance monitoring and optimization
      (function() {
        // Mark critical resources
        if ('performance' in window && 'mark' in performance) {
          performance.mark('head-start');
        }
        
        // Preload critical resources immediately
        var criticalResources = [
          { href: '/customBanner2.webp', as: 'image', fetchpriority: 'high' },
          { href: 'https://res.cloudinary.com/dqcfamwuf/image/upload/v1751867708/banners/yuky_v1.webp', as: 'image', fetchpriority: 'high' }
        ];
        
        criticalResources.forEach(function(resource) {
          var link = document.createElement('link');
          link.rel = 'preload';
          link.as = resource.as;
          link.href = resource.href;
          if (resource.fetchpriority) link.fetchPriority = resource.fetchpriority;
          document.head.appendChild(link);
        });
        
        // Resource hints for better performance
        var resourceHints = [
          { rel: 'dns-prefetch', href: '//res.cloudinary.com' },
          { rel: 'preconnect', href: 'https://etimadmart.up.railway.app' }
        ];
        
        resourceHints.forEach(function(hint) {
          if (!document.querySelector('link[href="' + hint.href + '"]')) {
            var link = document.createElement('link');
            link.rel = hint.rel;
            link.href = hint.href;
            if (hint.rel === 'preconnect') link.crossOrigin = 'anonymous';
            document.head.appendChild(link);
          }
        });
        
        // Critical CSS loaded indicator
        document.documentElement.classList.add('critical-css-loaded');
        
        // Mark when head processing is complete
        if ('performance' in window && 'mark' in performance) {
          performance.mark('head-end');
        }
      })();
      
      // Mobile-optimized resource loading
      window.addEventListener('load', function() {
        var isMobile = window.innerWidth <= 768;
        var delay = isMobile ? 2000 : 1000; // Longer delay on mobile
        
        setTimeout(function() {
          var resources = isMobile 
            ? ['/api/products'] // Only essential API on mobile
            : ['/api/products', '/api/categories', '/api/banners'];
          
          resources.forEach(function(href) {
            var link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = href;
            document.head.appendChild(link);
          });
        }, delay);
      });
    </script>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-WB2JJH4Z"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <noscript
      ><img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=2204362540002843&ev=PageView&noscript=1"
    /></noscript>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
